"use strict";var score=0,GlobalSpeed=1,areas=[],scoreCnt=[0,0,0,0],LevelFrames=[],curFrame=0;const LIMIT_BAD=180,LIMIT_GOOD=160,LIMIT_PERFECT=80,MAX_RENDER_DISTANCE=125,FPMS=.06;var fpssc=0,combo=0;class Acc{constructor(e,t,s,i){this.div=document.createElement("div"),this.div.className="acc acc-"+i,this.div.style.left=t+"%",this.div.style.top=s+"%",this.div.addEventListener("animationend",this.div.remove),this.area=e,this.area.div.appendChild(this.div);let n=new Audio("sounds/tap.wav");n.addEventListener("ended",()=>{n.srcObject=null,n.remove()}),document.body.appendChild(n),n.play()}}class Tap{constructor(e,t,s,i,n){this.div=document.createElement("div"),this.div.className="tap",this.div.style.left=t+"%",this.div.style.top=(s||0)+"%",this.speedX=i||0,this.speedY=n||1,this.area=e,this.line=this.area.line,this.area.taps.push(this),this.area.div.appendChild(this.div)}get x(){return getPercent(this.div.style.left)}set x(e){this.div.style.left=e+"%"}get y(){return getPercent(this.div.style.top)}set y(e){this.div.style.top=e+"%"}check(e){if(e<=LIMIT_PERFECT)scoreCnt[0]++,new Acc(this.area,this.x,this.line.y,"perfect"),this.div.remove(),combo++;else if(e<=LIMIT_GOOD)scoreCnt[1]++,new Acc(this.area,this.x,this.line.y,"good"),this.div.remove(),combo++;else{if(!(e<=LIMIT_BAD))throw new Error(e+"ms is invaild for Tap.check");scoreCnt[2]++,this.div.className+=" tap-bad",this.div.addEventListener("animationend",this.div.remove),combo=0}updateScore()}move(){var e=this.y+this.speedY*LevelSpeed*GlobalSpeed;return e-this.line.y>this.speedY*LevelSpeed*GlobalSpeed*FPMS*LIMIT_BAD&&(this.div.className+=" tap-miss",combo=0,updateScore()),e>MAX_RENDER_DISTANCE?(this.div.remove(),!0):(this.y=e,!1)}}class Line{constructor(e,t){this.div=document.createElement("div"),this.div.className="line",this.div.style.top=(t||75)+"%",this.area=e,this.area.div.appendChild(this.div)}get y(){return getPercent(this.div.style.top)}set y(e){this.div.style.top=e+"%"}}class Area{constructor(e){this.div=document.createElement("div"),this.div.className="area",this.taps=[],this.line=new Line(this,e),areas.push(this),null!=(e=document.getElementById("areas"))&&e.appendChild(this.div)}TapMake(e,t,s,i){new Tap(this,e,t,s,i)}step(){for(let e=0;e<this.taps.length;e++)this.taps[e].move()&&this.taps.splice(e--,1)}}function updateScore(){score=9e5/LevelNoteNum*(scoreCnt[0]+.8*scoreCnt[1]+.2*scoreCnt[2]),document.getElementById("score").innerText=score.toFixed(0).padStart(7,"0"),0<combo?(document.getElementById("combo").style.display="block",document.getElementById("comboN").innerHTML=combo.toString()):document.getElementById("combo").style.display="none"}function getPercent(e){return Number(e.replace("%",""))}function getDeg(e){return Number(e.split("rotate(")[1].split("deg)")[0])}function step(){window.requestAnimationFrame(step),LevelFrames[curFrame]&&LevelFrames[curFrame].forEach(e=>{e()}),curFrame++;for(let e=0;e<areas.length;e++)areas[e].step()}function checkTouch(t){t.preventDefault();for(let e=0;e<t.touches.length;e++){var i=t.touches[e];for(let e=0;e<areas.length;e++){var n=areas[e],r=n.taps;if(0!=r.length){let e=0;n.div.style.transform&&(e=getDeg(n.div.style.transform));var a=rotatePoint(i.clientX,i.clientY,percent2pxW(50),percent2pxH(50),-e);let t=-1,s=Number.MAX_SAFE_INTEGER;for(let e=0;e<r.length;e++){var o=r[e];8<Math.abs(o.x-px2percentW(a.x))||(o=Math.abs(o.y-o.line.y)/(o.speedY*LevelSpeed*GlobalSpeed*FPMS))<=s&&o<=LIMIT_BAD&&(s=o,t=e)}0<=t&&(r[t].check(s),r.splice(t,1))}}}}var initCnt=2;function init(){var e;2==initCnt?(null!=(e=document.getElementById("gameWindow"))&&e.requestFullscreen({navigationUI:"hide"}),document.getElementById("startBtn").innerText="开始",document.getElementById("landscape").style.display="",initCnt--):(null!=(e=document.getElementById("startBtn"))&&e.remove(),null!=(e=document.getElementById("tips"))&&e.remove(),updateScore(),LevelInit())}function start(){var e;null!=(e=document.getElementById("areas"))&&e.addEventListener("touchstart",checkTouch),window.requestAnimationFrame(step)}function setFrameout(e,t){if(t<0)throw new Error("ms less than 0");t=Math.round(t*FPMS);LevelFrames[t]||(LevelFrames[t]=Array()),LevelFrames[t].push(e)}function setFrameoutF(e,t){if(t<0)throw new Error("Frame less than 0");t=Math.round(t);LevelFrames[t]||(LevelFrames[t]=Array()),LevelFrames[t].push(e)}function rotatePoint(e,t,s,i,n){return{x:s+(e-s)*Math.cos(n*Math.PI/180)-(t-i)*Math.sin(n*Math.PI/180),y:i+(e-s)*Math.sin(n*Math.PI/180)+(t-i)*Math.cos(n*Math.PI/180)}}function px2percentW(e){return 100*e/window.innerWidth}function px2percentH(e){return 100*e/window.innerHeight}function percent2pxW(e){return window.innerWidth*e/100}function percent2pxH(e){return window.innerHeight*e/100}