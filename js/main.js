"use strict";var GlobalSpeed=1,GlobalDelay=0,areas=[],scoreCnt=[0,0,0,0],score=0,LevelFrames=[],curFrame=-GlobalDelay;const LIMIT_BAD=180,LIMIT_GOOD=160,LIMIT_PERFECT=80,MAX_RENDER_DISTANCE=125,FPMS=.06;var curTouches,soundTap,soundDrag,soundFlick,fpssc=0,combo=0,max_combo=0,APFC=2,musicLength=-1,reqId=-1;const AudioCtx=window.AudioContext||window.webkitAudioContext,audioCtx=new AudioContext;async function getFile(e){return fetch(e).then(e=>e.arrayBuffer()).then(e=>audioCtx.decodeAudioData(e))}function loadSounds(){getFile("assets/tap.wav").then(e=>{soundTap=e}),getFile("assets/drag.wav").then(e=>{soundDrag=e}),getFile("assets/flick.wav").then(e=>{soundFlick=e})}function soundPlay(e,t=0){e=new AudioBufferSourceNode(audioCtx,{buffer:e}),t=new StereoPannerNode(audioCtx,{pan:t});e.connect(t).connect(audioCtx.destination),e.start()}loadSounds();class Acc{constructor(e,t,s,i){this.div=document.createElement("div"),this.div.className="acc acc-"+i,this.div.style.left=t+"%",this.div.style.top=s+"%",this.div.addEventListener("animationend",this.div.remove),this.area=e,this.area.div.appendChild(this.div)}}class Note{constructor(e,t,s=0,i=0,n=1,r){this.area=e,this.speedXraw=i,this.speedYraw=n,this.div=document.createElement("div"),this.div.className="note",this.div.style.left=t+"%",this.div.style.top=s+"%",this.line=r||this.area.line,this.area.div.appendChild(this.div)}get x(){return getPercent(this.div.style.left)}set x(e){this.div.style.left=e+"%"}get y(){return getPercent(this.div.style.top)}set y(e){this.div.style.top=e+"%"}get speedX(){return this.speedXraw*LevelSpeed*GlobalSpeed}get speedY(){return this.speedYraw*LevelSpeed*GlobalSpeed}absPos(){return this.area.rel2abs(percent2pxW(this.x),percent2pxH(this.y))}getPan(){return px2percentW(this.absPos().x)/50-1}get missed(){return this.div.className.includes("miss")}miss(){this.missed||(this.div.className+=" note-miss",scoreCnt[3]++,combo=0)}}class Tap extends Note{constructor(e,t,s,i,n,r){super(e,t,s,i,n,r),this.div.className+=" tap",this.area.taps.push(this)}check(e){e<=LIMIT_GOOD?(e<=LIMIT_PERFECT?(scoreCnt[0]++,new Acc(this.area,this.x,this.line.y,"perfect")):(scoreCnt[1]++,new Acc(this.area,this.x,this.line.y,"good")),soundPlay(soundTap,this.getPan()),this.div.remove(),combo++):e<=LIMIT_BAD&&(scoreCnt[2]++,this.div.className+=" tap-bad",this.div.addEventListener("animationend",this.div.remove),combo=0)}move(){var e=this.y+this.speedY;return e-this.line.y>this.speedY*FPMS*LIMIT_BAD&&this.miss(),e>MAX_RENDER_DISTANCE?(this.div.remove(),!0):(this.y=e,!1)}}class Drag extends Note{constructor(e,t,s,i,n,r){super(e,t,s,i,n,r),this.div.className+=" drag",this.area.drags.push(this)}checkme(){if(!this.missed&&curTouches)for(let e=0;e<curTouches.length;e++){var t=curTouches[e],t=this.area.touch2rel(t);if(!(8<Math.abs(this.x-px2percentW(t.x))))if(-1<this.y-this.line.y)return this.check(),!0}return!1}check(e){scoreCnt[0]++,new Acc(this.area,this.x,this.line.y,"perfect"),soundPlay(soundDrag,this.getPan()),this.div.remove(),combo++}move(){var e;return!!this.checkme()||((e=this.y+this.speedY)-this.line.y>this.speedY*FPMS*LIMIT_PERFECT&&this.miss(),e>MAX_RENDER_DISTANCE?(this.div.remove(),!0):(this.y=e,!1))}}class Flick extends Note{constructor(e,t,s,i,n,r){super(e,t,s,i,n,r),this.div.className+=" flick",this.area.flicks.push(this)}check(e){scoreCnt[0]++,new Acc(this.area,this.x,this.line.y,"perfect"),soundPlay(soundFlick,this.getPan()),this.div.remove(),combo++}move(){var e=this.y+this.speedY;return e-this.line.y>this.speedY*FPMS*LIMIT_PERFECT&&this.miss(),e>MAX_RENDER_DISTANCE?(this.div.remove(),!0):(this.y=e,!1)}}class Hold extends Note{constructor(e,t,s,i,n,r,o){super(e,s,i,n,r,o),this.length=t,this.checked=!1,this.grade=3,this.force=!1,this.div.className+=" hold",this.area.holds.push(this),this.div.style.height=this.length+"%",this.top=this.y-this.length}check(e){this.checked=!0,e<=LIMIT_GOOD?(e<=LIMIT_PERFECT?(this.grade=0,new Acc(this.area,this.x,this.line.y,"perfect")):(this.grade=1,new Acc(this.area,this.x,this.line.y,"good")),this.area.reHolds.push(this),soundPlay(soundTap,this.getPan())):this.miss()}recheck(){if(!this.missed){if(this.force)return!0;if(this.length<10)return!0;if(curTouches)for(let e=0;e<curTouches.length;e++){var t=curTouches[e],t=this.area.touch2rel(t);if(Math.abs(this.x-px2percentW(t.x))<=8)return!0}}return!1}move(){var e=this.y+this.speedY;return this.top+=this.speedY,this.checked?(this.y<this.line.y?this.y=e:(this.y=this.line.y,this.length=this.y-this.top,this.div.style.height=this.length+"%"),Math.ceil(10*this.length)%5!=0||this.recheck()||(this.miss(),this.checked=!1),this.length<=0&&(scoreCnt[this.grade]++,this.div.remove(),combo++,!0)):(e-this.line.y>this.speedY*FPMS*LIMIT_BAD&&this.miss(),(this.y=e)>MAX_RENDER_DISTANCE&&(this.div.remove(),!0))}}class Line{constructor(e,t=75){this.div=document.createElement("div"),this.div.className="line",this.div.style.top=t+"%",this.area=e,this.area.div.appendChild(this.div)}get y(){return getPercent(this.div.style.top)}set y(e){this.div.style.top=e+"%"}}class Area{constructor(e){this.div=document.createElement("div"),this.div.className="area",this.taps=[],this.drags=[],this.flicks=[],this.holds=[],this.reHolds=[],this.line=new Line(this,e),this.accCnt=0,areas.push(this),null!=(e=document.getElementById("areas"))&&e.appendChild(this.div)}get deg(){return this.div.style.transform?Number(this.div.style.transform.split("rotate(")[1].split("deg)")[0]):0}newTap(e,t,s,i){new Tap(this,e,t,s,i)}newDrag(e,t,s,i){new Drag(this,e,t,s,i)}newFlick(e,t,s,i){new Flick(this,e,t,s,i)}newHold(e,t,s,i,n){new Hold(this,e,t,s,i,n)}newHoldT(e,t,s,i){new Hold(this,20,e,t,s,i)}step(){for(let e=0;e<this.taps.length;e++)this.taps[e].move()&&this.taps.splice(e--,1);for(let e=0;e<this.drags.length;e++)this.drags[e].move()&&this.drags.splice(e--,1);for(let e=0;e<this.flicks.length;e++)this.flicks[e].move()&&this.flicks.splice(e--,1);for(let e=0;e<this.holds.length;e++)this.holds[e].move()&&this.holds.splice(e--,1);for(let e=0;e<this.reHolds.length;e++)this.reHolds[e].move()&&this.reHolds.splice(e--,1)}touch2rel(e){return this.abs2rel(e.clientX,e.clientY)}abs2rel(e,t){return rotatePoint(e,t,percent2pxW(50),percent2pxH(50),-this.deg)}rel2abs(e,t){return rotatePoint(e,t,percent2pxW(50),percent2pxH(50),this.deg)}}function updateScore(){max_combo=Math.max(combo,max_combo),score=(9e5*(scoreCnt[0]+.65*scoreCnt[1])+1e5*max_combo)/LevelNoteNum,document.getElementById("score").innerText=score.toFixed(0).padStart(7,"0"),3<=combo?(document.getElementById("combo").style.display="block",document.getElementById("comboN").innerHTML=combo.toString()):document.getElementById("combo").style.display="none",0<scoreCnt[2]+scoreCnt[3]?APFC=0:2==APFC&&0<scoreCnt[1]&&(APFC=1),document.getElementById("APFC").innerHTML=".line{background:"+["white","var(--color-blue)","var(--color-gold)"][APFC]+"}"}function step(){if(reqId=window.requestAnimationFrame(step),!(curFrame<0)){LevelFrames[curFrame]&&LevelFrames[curFrame].forEach(e=>{e()}),curFrame++;for(let e=0;e<areas.length;e++){var t=areas[e],s=[t.taps,t.drags,t.flicks,t.holds];for(let t=0;t<s.length;t++){var i=s[t];for(let e=0;e<i.length;e++){var n=i[e];n.y>=n.line.y&&(n.check(0),i.splice(e--,1),3==t)&&(n.force=!0)}}t.step()}updateScore(),document.getElementById("time-bar").style.width=document.getElementById("time-bar-end").style.left=5*curFrame/3/LevelMusic.duration+"%"}}function updateTouch(e){e.preventDefault(),curTouches=e.touches}function checkTouch(t){t.preventDefault();for(let e=0;e<t.changedTouches.length;e++){var s=t.changedTouches[e];for(let e=0;e<areas.length;e++){var i=areas[e],n=[i.taps,i.holds],r=i.touch2rel(s);for(let e=0;e<n.length;e++){var o=n[e];let t=-1,s=[LIMIT_BAD,LIMIT_GOOD][e];for(let e=0;e<o.length;e++){var a=o[e];8<Math.abs(a.x-px2percentW(r.x))||(a=Math.abs(a.y-a.line.y)/(a.speedY*FPMS))<=s&&(s=a,t=e)}0<=t&&(o[t].check(s),o.splice(t,1))}}}curTouches=t.touches}function checkTouchMove(t){t.preventDefault();for(let e=0;e<=1;e++){var s=[t.touches,curTouches][e];for(let e=0;e<s.length;e++){var i=s[e];for(let e=0;e<areas.length;e++){var n=areas[e],r=n.flicks;if(0!=r.length){var o=n.touch2rel(i);for(let e=0;e<r.length;e++){var a=r[e];8<Math.abs(a.x-px2percentW(o.x))||-6<a.y-a.line.y&&(a.check(),r.splice(e--,1))}}}}}curTouches=t.touches}var music,initCnt=2;function init(){var e;2==initCnt?(null!=(e=document.getElementById("gameWindow"))&&e.requestFullscreen({navigationUI:"hide"}),document.getElementById("startBtn").innerText="开始",document.getElementById("landscape").style.display="",initCnt--):(null!=(e=document.getElementById("startBtn"))&&e.remove(),null!=(e=document.getElementById("tips"))&&e.remove(),document.body.appendChild(LevelMusic),LevelInit(),LevelMusic.addEventListener("canplaythrough",start),LevelMusic.load(),music=audioCtx.createMediaElementSource(LevelMusic))}function start(){var e;LevelMusic.removeEventListener("canplaythrough",start),musicLength=LevelMusic.duration,null!=(e=document.getElementById("areas"))&&e.addEventListener("touchstart",checkTouch),null!=(e=document.getElementById("areas"))&&e.addEventListener("touchmove",checkTouchMove),null!=(e=document.getElementById("areas"))&&e.addEventListener("touchend",updateTouch),null!=(e=document.getElementById("areas"))&&e.addEventListener("touchcancel",checkTouchMove),LevelMusic.volume=.5,LevelStart(),music.connect(audioCtx.destination),reqId=window.requestAnimationFrame(step)}function getPage(e,t){const s=new XMLHttpRequest;s.onload=()=>{t(s.responseXML)},s.open("GET",e),s.responseType="document",s.send()}function end(){var e;0<=reqId&&cancelAnimationFrame(reqId);let t=document.createElement("style");null!=(e=document.getElementById("player"))&&e.appendChild(t),t.innerHTML="#top-bar{top:-10%}#time-bar,#time-bar-end{display:none}",setTimeout(()=>{t.innerHTML+=".line{top:50%!important;width:0%}"},750),setTimeout(end2,1500)}function end2(){let s;getPage("pages/final.html",e=>{e.getElementById("final-sc").innerText=score.toFixed(0).padStart(7,"0"),e.getElementById("final-combo").innerText=max_combo.toFixed(0),e.getElementById("final-acc").innerText=((100*scoreCnt[0]+65*scoreCnt[1])/LevelNoteNum).toFixed(2)+"%",e.getElementById("scPerfect").innerText=scoreCnt[0].toFixed(0),e.getElementById("scGood").innerText=scoreCnt[1].toFixed(0),e.getElementById("scBad").innerText=scoreCnt[2].toFixed(0),e.getElementById("scMiss").innerText=scoreCnt[3].toFixed(0),e.getElementById("scEarly").innerText="?",e.getElementById("scLate").innerText="?";let t;t=2==APFC?'<span style="color:var(--color-gold);top:-5vh;font-family:sans-serif">'+String.fromCharCode(966)+"</span>":1==APFC?'<span style="color:var(--color-blue)">V</span>':96e4<=score?"V":92e4<=score?"S":88e4<=score?"A":82e4<=score?"B":7e5<=score?"C":"F",e.getElementById("final-grade").innerHTML=t,s=e.getElementById("final"),null!=(e=document.getElementById("gameWindow"))&&e.appendChild(s),setTimeout(()=>{var e;null!=(e=document.getElementById("finalAni"))&&e.remove()},500),null!=(e=document.getElementById("player"))&&e.remove()})}function setFrameout(e,t){setFrameoutF(e,t*FPMS)}function setFrameoutF(e,t){if(t<0)throw new Error("Frame less than 0");t=Math.round(t);LevelFrames[t]||(LevelFrames[t]=[]),LevelFrames[t].push(e)}function setNextFrame(e){var t=curFrame+1;LevelFrames[t]||(LevelFrames[t]=[]),LevelFrames[t].push(e)}function rotatePoint(e,t,s,i,n){return{x:s+(e-s)*Math.cos(n*Math.PI/180)-(t-i)*Math.sin(n*Math.PI/180),y:i+(e-s)*Math.sin(n*Math.PI/180)+(t-i)*Math.cos(n*Math.PI/180)}}function px2percentW(e){return 100*e/window.innerWidth}function px2percentH(e){return 100*e/window.innerHeight}function percent2pxW(e){return window.innerWidth*e/100}function percent2pxH(e){return window.innerHeight*e/100}function getPercent(e){return Number(e.replace("%",""))}function url(e,t){return location.host.includes(":")?e:t||"https://fastly.jsdelivr.net/gh/Phinows/phinows.github.io@master/"+e}